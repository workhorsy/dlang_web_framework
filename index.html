<!DOCTYPE html>

<!-- See: https://wiki.dlang.org/Generating_WebAssembly_with_LDC -->
<html>
	<head>
		<meta http-equiv="Content-Type" content="text/html; charset=UTF-8" />
		<title>Dlang Web Framework</title>
	</head>
	<body>
		<p>Click the buttons ...</p>
		<button id="go">Click to boom!</button>
		<button id="add">Click to add!</button>
	</body>
	<script>
		let exports = {};

		const console_log = (pointer, length) => {
			const view = new Uint8Array(exports.memory.buffer, pointer, length);
			let message = new TextDecoder().decode(view);
			console.log(message);
		};

		const import_object = {
			memory: new WebAssembly.Memory({ initial: 256, maximum: 256, shared: true }),
			env: {
				console_log,
			},
		};

		fetch('wasm.wasm').then(response =>
			response.arrayBuffer()
		).then(bytes =>
			WebAssembly.instantiate(bytes, import_object)
		).then(result => {
			exports = result.instance.exports;

			let go = document.querySelector("#go");
			go.addEventListener("click", exports.boom);

			let add = document.querySelector("#add");
			add.addEventListener("click", on_add);
		});

		function on_add() {
			const r = exports.add(42, -2.5);
			console.log('r = ' + r);
		}
	</script>
</html>
